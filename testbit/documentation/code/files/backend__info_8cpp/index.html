<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://rc1242rc.github.io/testbit/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://rc1242rc.github.io/testbit/fonts/vendor/jost/jost-v4-latin-500.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://rc1242rc.github.io/testbit/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><script>(()=>{var e=localStorage.getItem("theme");e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><link rel=stylesheet href=https://rc1242rc.github.io/testbit/main.1fa2debdf0a1b20e7268d11906902449af896197928a5bdae9dca95b629cdd73746db3d8c6afacb7320d9deb149a318c764669d08a1ddfd34a657ab2aeab866a.css integrity="sha512-H6LevfChsg5yaNEZBpAkSa+JYZeSilva6dypW2Kc3XN0bbPYxq+stzINnesUmjGMdkZp0Iod39NKZXqyrquGag==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>file src/backend_info.cpp - GAMBIT</title><meta name=description content="[No description available]"><link rel=canonical href=https://rc1242rc.github.io/testbit/documentation/code/files/backend__info_8cpp/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="file src/backend_info.cpp"><meta property="og:description" content="[No description available]"><meta property="og:url" content="https://rc1242rc.github.io/testbit/documentation/code/files/backend__info_8cpp/"><meta property="og:site_name" content="GAMBIT"><meta property="og:image" content="https://rc1242rc.github.io/testbit/gambit_logo.png"><meta property="og:image:alt" content="GAMBIT"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content><meta name=twitter:creator content><meta name=twitter:title content="file src/backend_info.cpp"><meta name=twitter:description content="[No description available]"><meta name=twitter:image content="https://rc1242rc.github.io/testbit/gambit_logo.png"><meta name=twitter:image:alt content="file src/backend_info.cpp"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://rc1242rc.github.io/#/schema/organization/1","name":"Doks","url":"https://rc1242rc.github.io/","sameAs":["https://github.com/GambitBSM"],"logo":{"@type":"ImageObject","@id":"https://rc1242rc.github.io/#/schema/image/1","url":"https://rc1242rc.github.io/logo-doks.png","width":450,"height":416,"caption":"Doks"},"image":{"@id":"https://rc1242rc.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://rc1242rc.github.io/#/schema/website/1","url":"https://rc1242rc.github.io/","name":"GAMBIT","description":"Documentation for the Global And Modular BSM Inference Tool","publisher":{"@id":"https://rc1242rc.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://rc1242rc.github.io/testbit/documentation/code/files/backend__info_8cpp/","url":"https://rc1242rc.github.io/testbit/documentation/code/files/backend__info_8cpp/","name":"file src\/backend_info.cpp","description":"[No description available]","isPartOf":{"@id":"https://rc1242rc.github.io/#/schema/website/1"},"about":{"@id":"https://rc1242rc.github.io/#/schema/organization/1"},"datePublished":"0001-01-01T00:00:00CET","dateModified":"0001-01-01T00:00:00CET","breadcrumb":{"@id":"https://rc1242rc.github.io/testbit/documentation/code/files/backend__info_8cpp/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://rc1242rc.github.io/testbit/documentation/code/files/backend__info_8cpp/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://rc1242rc.github.io/testbit/documentation/code/files/backend__info_8cpp/"]}]},{"@type":"BreadcrumbList","@id":"https://rc1242rc.github.io/testbit/documentation/code/files/backend__info_8cpp/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://rc1242rc.github.io/testbit","url":"https://rc1242rc.github.io/testbit","name":"Home"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://rc1242rc.github.io/testbit/documentation/","url":"https://rc1242rc.github.io/testbit/documentation/","name":"Documentation"}},{"@type":"ListItem","position":4,"item":{"@type":"WebPage","@id":"https://rc1242rc.github.io/testbit/documentation/code/","url":"https://rc1242rc.github.io/testbit/documentation/code/","name":"Code"}},{"@type":"ListItem","position":5,"item":{"@type":"WebPage","@id":"https://rc1242rc.github.io/testbit/documentation/code/files/","url":"https://rc1242rc.github.io/testbit/documentation/code/files/","name":"Files"}},{"@type":"ListItem","position":6,"item":{"@id":"https://rc1242rc.github.io/testbit/documentation/code/files/backend__info_8cpp/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://rc1242rc.github.io/testbit/documentation/code/files/backend__info_8cpp/#/schema/image/2","url":"https://rc1242rc.github.io/testbit/gambit_logo.png","contentUrl":"https://rc1242rc.github.io/testbit/gambit_logo.png","caption":"file src\/backend_info.cpp"}]}]}</script><meta name=theme-color content="#fff"><link rel=icon href=https://rc1242rc.github.io/testbit/favicon.ico sizes=any><link rel=icon type=image/svg+xml href=https://rc1242rc.github.io/testbit/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=https://rc1242rc.github.io/testbit/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://rc1242rc.github.io/testbit/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://rc1242rc.github.io/testbit/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://rc1242rc.github.io/testbit/site.webmanifest></head><body class="documentation single light"><div class=sticky-top><div class=header-bar></div><header class="navbar navbar-expand-md navbar-light doks-navbar"><nav class="container-xxl flex-wrap flex-md-nowrap" aria-label="Main navigation"><a class="navbar-brand p-0 me-auto" href=/ aria-label=GAMBIT><img class=logo-light src=https://rc1242rc.github.io/testbit/images/gambit_logo.png width=50px>
<img class="logo-dark d-none" src=https://rc1242rc.github.io/testbit/images/gambit_logo.png width=50px>
GAMBIT</a>
<button class="btn btn-menu order-2 d-block d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-end border-0 py-lg-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-lg-none"></div><div class="offcanvas-header d-lg-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=/>GAMBIT</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body p-4 p-lg-0"><ul class="nav flex-column flex-lg-row align-items-lg-center mt-2 mt-lg-0 ms-lg-2 me-lg-auto"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle ps-0 py-1" href=# id=navbarDropdownMenuLink role=button data-bs-toggle=dropdown aria-expanded=false>Documentation
<span class=dropdown-caret><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></span></a><ul class="dropdown-menu dropdown-menu-main shadow rounded border-0" aria-labelledby=navbarDropdownMenuLink><li><a class=dropdown-item href=/testbit/documentation/installation/introduction/>Installation</a></li><li><a class=dropdown-item href=/testbit/documentation/examples/colliderbit>Examples</a></li><li><a class=dropdown-item href=/testbit/documentation/help/faqs/>Help</a></li><li><a class=dropdown-item href=/testbit/documentation/code/index_classes>Code Reference</a></li></ul></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle ps-0 py-1" href=# id=navbarDropdownMenuLink role=button data-bs-toggle=dropdown aria-expanded=false>Community
<span class=dropdown-caret><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></span></a><ul class="dropdown-menu dropdown-menu-main shadow rounded border-0" aria-labelledby=navbarDropdownMenuLink><li><a class=dropdown-item href=/testbit/community/publications/>Publications</a></li><li><a class=dropdown-item href=/testbit/community/talks/>Talks</a></li><li><a class=dropdown-item href=/testbit/community/members/>Members</a></li><li><a class=dropdown-item href=/testbit/community/code_of_conduct/>Code of Conduct</a></li><li><a class=dropdown-item href=/testbit/community/contact/>Contact</a></li></ul></li></ul><hr class="text-black-50 my-4 d-lg-none"><form class="doks-search position-relative flex-grow-1 ms-lg-auto me-lg-2"><input id=search class="form-control is-search" type=search placeholder="Search site..." aria-label="Search site..." autocomplete=off><div id=suggestions class="shadow bg-white rounded d-none"></div></form><hr class="text-black-50 my-4 d-lg-none"><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=https://github.com/GambitBSM><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-lg-none">GitHub</small></a></li></ul><hr class="text-black-50 my-4 d-lg-none"><div class=dropdown><button class="btn btn-doks-light dropdown-toggle" id=doks-versions data-bs-toggle=dropdown aria-expanded=false data-bs-display=static aria-label="Toggle version menu">
<span class=d-none>Doks</span> TestBit
<span class=dropdown-caret><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></span></button><ul class="dropdown-menu dropdown-menu-lg-end me-lg-2 shadow rounded border-0" aria-labelledby=doks-versions><li><a class=dropdown-item href=/maindevelopment/documentation/code/index_classes/>MainDevelopment</a></li><li><a class=dropdown-item href=/testbit/documentation/code/index_classes/>TestBit</a></li></ul></div></div></div></nav></header></div><div class="wrap container-xxl" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 docs-sidebar"><nav class=docs-links aria-label="Main navigation"><ul class="list-unstyled collapsible-sidebar"><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-installation aria-expanded=false>
Installation</button><div class=collapse id=section-installation><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=/testbit/documentation/installation/introduction/>Getting Started</a></li><li><a class="docs-link rounded" href=/testbit/documentation/installation/docker_usage/>Docker Usage</a></li><li><a class="docs-link rounded" href=/testbit/documentation/installation/installation_for_linux/>Installation for Linux</a></li><li><a class="docs-link rounded" href=/testbit/documentation/installation/installation_for_windows/>Installation for Windows</a></li><li><a class="docs-link rounded" href=/testbit/documentation/installation/installation_for_macos/>Installation for macOS</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-examples aria-expanded=false>
Examples</button><div class=collapse id=section-examples><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=/testbit/documentation/examples/colliderbit/>ColliderBit</a></li><li><a class="docs-link rounded" href=/testbit/documentation/examples/anotherbit/>AnotherBit</a></li><li><a class="docs-link rounded" href=/testbit/documentation/examples/anotherbit2/>AnotherBit2</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-help aria-expanded=false>
Help</button><div class=collapse id=section-help><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=/testbit/documentation/help/faqs/>FAQs</a></li><li><a class="docs-link rounded" href=/testbit/documentation/help/compiler_matrix/>Compiler Matrix</a></li><li><a class="docs-link rounded" href=/testbit/documentation/help/known_issues/>Known Issues</a></li><li><a class="docs-link rounded" href=/testbit/documentation/help/configuration_examples/>Configuration Examples</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-code aria-expanded=false>
Code Reference</button><div class=collapse id=section-code><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=/testbit/documentation/code/index_classes/>Classes</a></li><li><a class="docs-link rounded" href=/testbit/documentation/code/index_files/>Files</a></li><li><a class="docs-link rounded" href=/testbit/documentation/code/index_pages/>Pages</a></li><li><a class="docs-link rounded" href=/testbit/documentation/code/index_namespaces/>Namespaces</a></li></ul></div></li></ul></nav></div><nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=d-xl-none><button class="btn btn-outline-primary btn-sm doks-toc-toggle collapsed" type=button data-bs-toggle=collapse data-bs-target=#onThisPage aria-controls=doks-docs-nav aria-expanded=false aria-label="Toggle On this page navigation">
<span>On this page</span>
<span><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-expand" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Expand</title><polyline points="7 13 12 18 17 13"/><polyline points="7 6 12 11 17 6"/></svg><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-collapse" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Collapse</title><polyline points="17 11 12 6 7 11"/><polyline points="17 18 12 13 7 18"/></svg></span></button><div class=collapse id=onThisPage><div class="card card-body mt-3 py-1"><div class=page-links><nav id=TableOfContents><ul><li><ul><li><a href=#namespaces>Namespaces</a></li><li><a href=#detailed-description>Detailed Description</a></li><li><a href=#source-code>Source code</a></li></ul></li></ul></nav></div></div></div></div><div class="page-links d-none d-xl-block"><h3>On this page</h3><nav id=TableOfContents><ul><li><ul><li><a href=#namespaces>Namespaces</a></li><li><a href=#detailed-description>Detailed Description</a></li><li><a href=#source-code>Source code</a></li></ul></li></ul></nav></div></nav><main class="docs-content col-lg-11 col-xl-9 mx-xl-auto"><h1>file src/backend_info.cpp</h1><p class=lead></p><p>[No description available] <a href=#detailed-description>More&mldr;</a></p><h2 id=namespaces>Namespaces <a href=#namespaces class=anchor aria-hidden=true>#</a></h2><table><thead><tr><th>Name</th></tr></thead><tbody><tr><td><strong><a href=/documentation/code/namespaces/namespacegambit/>Gambit</a></strong><br>TODO: see if we can use this one:</td></tr></tbody></table><h2 id=detailed-description>Detailed Description <a href=#detailed-description class=anchor aria-hidden=true>#</a></h2><p><strong>Author</strong>:</p><ul><li>Pat Scott (<a href=mailto:patscott@physics.mcgill.ca>patscott@physics.mcgill.ca</a>)</li><li>Patrick Stoecker (<a href=mailto:stoecker@physik.rwth-aachen.de>stoecker@physik.rwth-aachen.de</a>)</li></ul><p><strong>Date</strong>:</p><ul><li>2014 Dec</li><li>2017 Dec</li><li>2019 Jun</li></ul><p>Container used for storing info about backends during initialisation time.</p><hr><p>Authors (add name and date if you modify):</p><hr><h2 id=source-code>Source code <a href=#source-code class=anchor aria-hidden=true>#</a></h2><pre><code>//   GAMBIT: Global and Modular BSM Inference Tool
//   *********************************************

#include &lt;dlfcn.h&gt;

#include &quot;gambit/cmake/cmake_variables.hpp&quot;
#include &quot;gambit/Backends/backend_info.hpp&quot;
#include &quot;gambit/Utils/util_functions.hpp&quot;
#include &quot;gambit/Logs/logger.hpp&quot;

#ifdef HAVE_MATHEMATICA
  #include MATHEMATICA_WSTP_H
#endif

#ifdef HAVE_PYBIND11

  #include &quot;gambit/Utils/begin_ignore_warnings_pybind11.hpp&quot;
  #include &lt;pybind11/embed.h&gt;
  #include &quot;gambit/Utils/end_ignore_warnings.hpp&quot;

#endif

#ifdef HAVE_LINK_H
  #include &lt;link.h&gt;
#endif


namespace Gambit
{

  // Public method definitions for backend_info class

  Backends::backend_info::backend_info()
   : filename(GAMBIT_DIR &quot;/config/backend_locations.yaml&quot;)
   , default_filename(GAMBIT_DIR &quot;/config/backend_locations.yaml.default&quot;)
   #ifdef HAVE_PYBIND11
     , python_started(false)
   #endif
  {
    // Attempt to read user yaml configuration file
    try
    {
      bepathfile = YAML::LoadFile(filename);
      logger() &lt;&lt; LogTags::backends &lt;&lt; LogTags::debug &lt;&lt; &quot;Successfully loaded custom user backend location file &quot;
               &lt;&lt; filename &lt;&lt; &quot;.&quot; &lt;&lt; EOM;
      custom_bepathfile_exists = true;
    }
    catch (YAML::Exception &amp;e)
    {
      logger() &lt;&lt; LogTags::backends &lt;&lt; LogTags::debug &lt;&lt; &quot;Custom user backend location file &quot; &lt;&lt; filename
               &lt;&lt; &quot; could not be read; employing default only.&quot; &lt;&lt; EOM;
      custom_bepathfile_exists = false;
    }
    // Attempt to read default yaml configuration file
    try
    {
      default_bepathfile = YAML::LoadFile(default_filename);
      logger() &lt;&lt; LogTags::backends &lt;&lt; LogTags::debug &lt;&lt; &quot;Successfully loaded default backend location file &quot;
               &lt;&lt; default_filename &lt;&lt; &quot;.&quot; &lt;&lt; EOM;
    }
    catch (YAML::Exception &amp;e)
    {
      std::ostringstream msg;
      msg &lt;&lt; &quot;Could not read default backend locations file \&quot;&quot;&lt;&lt;filename&lt;&lt;&quot;\&quot;!&quot; &lt;&lt; endl;
      msg &lt;&lt; &quot;Please check that file exists and contains valid YAML.&quot; &lt;&lt; endl;
      msg &lt;&lt; &quot;(&quot;&lt;&lt;e.what()&lt;&lt;&quot;)&quot;;
      backend_error().raise(LOCAL_INFO,msg.str());
    }
  }

  Backends::backend_info::~backend_info()
  {
    #ifdef HAVE_PYBIND11
      if (python_started)
      {
        for (auto it = loaded_python_backends.begin();
                  it != loaded_python_backends.end();
                  it++)
        {
          delete it-&gt;second;
        }
        delete python_interpreter;
      }
    #endif
  }

  bool Backends::backend_info::custom_locations_exist() const
  {
    return custom_bepathfile_exists;
  }

  str Backends::backend_info::backend_locations() const
  {
    return filename;
  }

  str Backends::backend_info::default_backend_locations() const
  {
    return default_filename;
  }

  str Backends::backend_info::path(str be, str ver) const
  {
    const str default_path(&quot;no path in config/backend_locations.yaml.default&quot;);
    str p;
    auto be_it = bepathoverrides.find(be);
    bool override_present = (be_it != bepathoverrides.end());
    if (override_present)
    {
      auto ver_it = be_it-&gt;second.find(ver);
      if (ver_it != be_it-&gt;second.end())
      {
        p = ver_it-&gt;second;
        if (p.substr(0,2) == &quot;./&quot;) p = p.substr(2,p.npos);
      }
      else
      {
        override_present = false;
      }
    }
    if (not override_present)
    {
      if (custom_bepathfile_exists and bepathfile[be] and bepathfile[be][ver])
      {
        p = bepathfile[be][ver].as&lt;str&gt;();
        if (p.substr(0,2) == &quot;./&quot;) p = p.substr(2,p.npos);
      }
      else
      {
        if (default_bepathfile[be] and default_bepathfile[be][ver])
        {
          p = default_bepathfile[be][ver].as&lt;str&gt;();
          if (p.substr(0,2) == &quot;./&quot;) p = p.substr(2,p.npos);
        }
        else
        {
          p = default_path;
          static bool warning_raised = false;
          if (not warning_raised)
          {
            std::ostringstream msg;
            msg &lt;&lt; &quot;Could not find path for backend &quot;&lt;&lt; be &lt;&lt;&quot; v&quot; &lt;&lt; ver &lt;&lt; endl;
            msg &lt;&lt; &quot;in &quot; &lt;&lt; default_filename;
            if (custom_bepathfile_exists) msg &lt;&lt; &quot; nor in &quot; &lt;&lt; filename;
            msg &lt;&lt; &quot;.&quot; &lt;&lt; endl;
            msg &lt;&lt; &quot;Setting path to \&quot;&quot; &lt;&lt; default_path &lt;&lt; &quot;\&quot;.&quot;;
            backend_warning().raise(LOCAL_INFO,msg.str());
            warning_raised = true;
          }
        }
      }
    }
    return p;
  }

  str Backends::backend_info::corrected_path(str be, str ver) const
  {
    str p = path(be,ver);
    if (p.substr(0,1) != &quot;/&quot;)
    {
      p = GAMBIT_DIR &quot;/&quot;+p;
    }
    return p;
  }

  str Backends::backend_info::path_dir(str be, str ver) const
  {
    str p = corrected_path(be,ver);
    for (int i = p.length()-1; i &gt;= 0; --i)
    {
      if (p[i] == '/') return p.substr(0,i);
    }
    return p;
  }

  str Backends::backend_info::lib_name(str be, str ver) const
  {
    str p = corrected_path(be,ver);
    int i, end = p.length();
    for (i = end-1; i &gt;= 0; --i)
    {
      if (p[i] == '.') end = i-1;
      if (p[i] == '/') break;
    }
    return p.substr(i+1,end-i);
  }

  str Backends::backend_info::version_from_safe_version (str be, str sv) const
  {
    return safe_version_map.at(be).first.at(sv);
  }

  str Backends::backend_info::safe_version_from_version (str be, str v) const
  {
    return safe_version_map.at(be).second.at(v);
  }

  void Backends::backend_info::link_versions(str be, str v, str sv)
  {
    safe_version_map[be].first[sv] = v;
    safe_version_map[be].second[v] = sv;
  }

  void Backends::backend_info::override_path(const str&amp; be, const str&amp; ver, str path)
  {
    int l = str(GAMBIT_DIR).length();
    if (path.substr(0,l) == GAMBIT_DIR) path.replace(0, l, &quot;.&quot;);
    bepathoverrides[be][ver] = path;
  }

  str Backends::backend_info::default_version(const str&amp; be) const
  {
    if (default_safe_versions.find(be) == default_safe_versions.end())
    {
      std::ostringstream msg;
      msg &lt;&lt; &quot;The backend \&quot;&quot; &lt;&lt; be &lt;&lt; &quot;\&quot; does not contain any classes for loading, &quot;
          &lt;&lt; endl &lt;&lt; &quot;and therefore has no default version.&quot;;
      backend_error().raise(LOCAL_INFO, msg.str());
    }
    return version_from_safe_version(be,default_safe_versions.at(be));
  }

  std::vector&lt;str&gt; Backends::backend_info::working_versions(const str&amp; be)
  {
    std::vector&lt;str&gt; working_versions;
    // Retrieve the versions known of the given backend.
    if (safe_version_map.find(be) == safe_version_map.end())
    {
      std::ostringstream msg;
      msg &lt;&lt; &quot;The backend \&quot;&quot; &lt;&lt; be &lt;&lt; &quot;\&quot; is not known to GAMBIT.&quot;;
      backend_error().raise(LOCAL_INFO, msg.str());
    }
    std::map&lt;str,str&gt; versions = safe_version_map[be].second;
    // Iterate over all known versions of the given backend, retaining only those that work.
    for (auto it = versions.begin(); it != versions.end(); ++it)
    {
      if (works.at(be + it-&gt;first)) working_versions.push_back(it-&gt;first);
    }
    return working_versions;
  }


  std::vector&lt;str&gt; Backends::backend_info::working_safe_versions(const str&amp; be)
  {
    // Get the working versions, then iterate over them and convert them to safe versions.
    std::vector&lt;str&gt; safe_versions;
    const std::vector&lt;str&gt; versions = working_versions(be);
    for (auto it = versions.begin(); it != versions.end(); ++it)
    {
      safe_versions.push_back(safe_version_from_version(be, *it));
    }
    return safe_versions;
  }


  void Backends::backend_info::attempt_backend_path_override(const str&amp; be, const str&amp; ver, const char* name)
  {
    char *fullname = realpath(name, NULL);
    if (not fullname)
    {
      std::ostringstream err;
      err &lt;&lt; &quot;Problem retrieving absolute library path for &quot; &lt;&lt; be &lt;&lt; &quot; v&quot; &lt;&lt; ver &lt;&lt; &quot;.&quot; &lt;&lt; endl
          &lt;&lt; &quot;The path to this library has not been fully determined.&quot;;
      backend_warning().raise(LOCAL_INFO,err.str());
    }
    else
    {
      override_path(be, ver, fullname);
    }
    free(fullname);
  }


  int Backends::backend_info::loadLibrary(const str&amp; be, const str&amp; ver, const str&amp; sv, bool with_BOSS, const str&amp; lang)
  {
    try
    {
      // Initialize variable to avoid issues later
      needsMathematica[be+ver] = false;
      needsPython[be+ver] = false;
      classloader[be+ver] = false;
      missingPythonVersion[be+ver] = -1;

     // Now switch according to the language of the backend
      if (lang == &quot;MATHEMATICA&quot;
       or lang == &quot;Mathematica&quot;)
      {
        needsMathematica[be+ver] = true;
        // And switch according to whether the language has its dependencies met or not
        #ifdef HAVE_MATHEMATICA
          loadLibrary_Mathematica(be, ver, sv);
        #else
          works[be+ver] = false;
          std::ostringstream err;
          err &lt;&lt; &quot;Backend requires Mathematica and WSTP, but one of them is not found in the system. &quot;
              &lt;&lt; &quot;Please install/buy Mathematica and/or WSTP before using this backend.&quot; &lt;&lt; endl;
          backend_warning().raise(LOCAL_INFO, err.str());
        #endif
      }
      // and so on.
      else if (lang == &quot;PYTHON&quot; or lang == &quot;Python&quot; or
               lang == &quot;PYTHON2&quot; or lang == &quot;Python2&quot; or
               lang == &quot;PYTHON3&quot; or lang == &quot;Python3&quot;)
      {
        needsPython[be+ver] = true;
        #ifdef HAVE_PYBIND11
          loadLibrary_Python(be, ver, sv, lang);
        #else
          works[be+ver] = false;
          std::ostringstream err;
          err &lt;&lt; &quot;GAMBIT requires pybind11 to interface with Python, but it was not found in &quot;
              &lt;&lt; &quot;the system. Please install it before using this backend.&quot; &lt;&lt; endl
              &lt;&lt; &quot;You can do this with 'make pybind11' from the GAMBIT build directory.&quot; &lt;&lt; endl;
          backend_warning().raise(LOCAL_INFO, err.str());
        #endif
      }
      else if (lang == &quot;C&quot;
            or lang == &quot;C++&quot;
            or lang == &quot;CC&quot;
            or lang == &quot;CXX&quot;
            or lang == &quot;CPP&quot;
            or lang == &quot;F90&quot;
            or lang == &quot;F95&quot;
            or lang == &quot;F2003&quot;
            or lang == &quot;FORTRAN&quot;
            or lang == &quot;Fortran&quot;)
      {
        loadLibrary_C_CXX_Fortran(be, ver, sv, with_BOSS);
      }
      else if (lang == &quot;DATA&quot; or lang == &quot;Data&quot;)
      {
        loadLibrary_data(be, ver, sv);
      }
      else
      {
        std::ostringstream err;
        err &lt;&lt; &quot;Unrecognised/unsupported backend language: &quot; &lt;&lt; lang &lt;&lt; endl;
        err &lt;&lt; &quot;Issue comes from &quot; &lt;&lt; be &lt;&lt; &quot; &quot; &lt;&lt; ver &lt;&lt; endl;
        backend_error().raise(LOCAL_INFO, err.str());
      }

    }

    catch (std::exception&amp; e)
    {
      std::cout &lt;&lt; &quot;GAMBIT has failed to initialise due to fatal exception when trying to load backends: &quot; &lt;&lt; e.what() &lt;&lt; std::endl;
      throw(e);
    }

    return 0;
  }

  void Backends::backend_info::loadLibrary_data(const str&amp; be, const str&amp; ver, const str&amp; sv)
  {
    const str path = corrected_path(be,ver);
    link_versions(be, ver, sv);
    classloader[be+ver] = false;
    needsMathematica[be+ver] = false;
    needsPython[be+ver] = false;

    if (Utils::file_exists(path))
    {
      logger() &lt;&lt; &quot;Succeeded in locating data library at &quot; &lt;&lt; path &lt;&lt; &quot;.&quot;
               &lt;&lt; LogTags::backends &lt;&lt; LogTags::info &lt;&lt; EOM;
      works[be+ver] = true;
    }
    else
    {
      backend_warning().raise(LOCAL_INFO,&quot;Failed to locate data library at &quot; + path + &quot;.&quot;);
      works[be+ver] = false;
    }
  }

  void Backends::backend_info::loadLibrary_C_CXX_Fortran(const str&amp; be, const str&amp; ver, const str&amp; sv, bool with_BOSS)
  {
    const str path = corrected_path(be,ver);
    link_versions(be, ver, sv);
    classloader[be+ver] = with_BOSS;
    needsMathematica[be+ver] = false;
    needsPython[be+ver] = false;

    if (with_BOSS) classes_OK[be+ver] = true;
    void* pHandle = dlopen(path.c_str(), RTLD_LAZY);
    if (pHandle)
    {
      // If dlinfo is available, use it to verify the path of the backend that was just loaded.
      #ifdef HAVE_LINK_H
        link_map *map;
        dlinfo(pHandle, RTLD_DI_LINKMAP, &amp;map);
        if (not map)
        {
          std::ostringstream err;
          err &lt;&lt; &quot;Problem retrieving library path.  The sought lib is &quot; &lt;&lt; path &lt;&lt; &quot;.&quot; &lt;&lt; endl
              &lt;&lt; &quot;The path to this library has not been fully verified.&quot;;
          backend_warning().raise(LOCAL_INFO,err.str());
        }
        else
        {
          attempt_backend_path_override(be, ver, map-&gt;l_name);
        }
      #else
        override_path(be, ver, &quot;.so loaded but path unverified (system lacks dlinfo)&quot;);
      #endif
      logger() &lt;&lt; &quot;Succeeded in loading &quot; &lt;&lt; corrected_path(be,ver)
               &lt;&lt; LogTags::backends &lt;&lt; LogTags::info &lt;&lt; EOM;
      works[be+ver] = true;
      loaded_C_CXX_Fortran_backends[be+ver] = pHandle;
    }
    else
    {
      std::ostringstream err;
      str error = dlerror();
      dlerrors[be+ver] = error;
      err &lt;&lt; &quot;Failed loading library from &quot; &lt;&lt; path &lt;&lt; &quot; due to: &quot; &lt;&lt; endl
          &lt;&lt; error &lt;&lt; endl
          &lt;&lt; &quot;All functions in this backend library will be disabled (i.e. given status = -1).&quot;;
      backend_warning().raise(LOCAL_INFO,err.str());
      works[be+ver] = false;
    }
  }


  #ifdef HAVE_MATHEMATICA

    void Backends::backend_info::loadLibrary_Mathematica(const str&amp; be, const str&amp; ver, const str&amp; sv)
    {
      const str path = corrected_path(be,ver);
      link_versions(be, ver, sv);
      classloader[be+ver] = false;
      needsMathematica[be+ver] = true;
      needsPython[be+ver] = false;

      int WSerrno;
      WSLINK pHandle;
      std::ostringstream err;

      // If the file does not exists do not wait for Mathematica to figure it out
      std::ifstream f(path.c_str());
      if(!f.good())
      {
        err &lt;&lt; &quot;Failed loading Mathematica package; package not found at &quot; &lt;&lt; path &lt;&lt; endl;
        backend_warning().raise(LOCAL_INFO, err.str());
        works[be+ver] = false;
        return;
      }

      // This initializes WSTP library functions.
      WSENV WSenv = WSInitialize(0);
      if(WSenv == NULL)
      {
        err &lt;&lt; &quot;Unable to initialize WSTP environment&quot; &lt;&lt; endl;
        backend_warning().raise(LOCAL_INFO,err.str());
        works[be+ver] = false;
        return;
      }

      // This opens a WSTP connection
      std::stringstream WSTPflags;
      #ifdef __APPLE__
        WSTPflags &lt;&lt; &quot;-linkname &quot; &lt;&lt; MATHEMATICA_KERNEL &lt;&lt; &quot; -mathlink&quot;;
      #else
        WSTPflags &lt;&lt; &quot;-linkname math -mathlink&quot;;
      #endif

      pHandle = WSOpenString(WSenv, WSTPflags.str().c_str(), &amp;WSerrno);
      if(pHandle == NULL || WSerrno != WSEOK)
      {
        if(pHandle != NULL)
        {
          err &lt;&lt; &quot;Received the following error message from WSErrorMessage: \&quot;&quot; &lt;&lt; WSErrorMessage(pHandle) &lt;&lt; &quot;\&quot;&quot; &lt;&lt; endl;
        }
        err &lt;&lt; &quot;Failed to establish link with the Mathematica kernel. Make sure that Mathematica is working or rebuild GAMBIT without Mathematica support by using the CMake flag -Ditch=\&quot;Mathematica\&quot;.&quot;;
        backend_error().raise(LOCAL_INFO,err.str());
      }

      // Tell WSTP to load up the Mathematica package of the backend
      if(!WSPutFunction(pHandle, &quot;Once&quot;, 1)
           or !WSPutFunction(pHandle, &quot;Get&quot;, 1)
           or !WSPutString(pHandle, path.c_str())
           or !WSEndPacket(pHandle))
      {
        err &lt;&lt; &quot;Error sending packet through WSTP&quot; &lt;&lt; endl;
        backend_warning().raise(LOCAL_INFO,err.str());
        backend_warning().raise(LOCAL_INFO, WSErrorMessage(pHandle));
        works[be+ver] = false;
        WSNewPacket(pHandle);
        return;
      }

      // Jump to the end of this packet, discarding all output
      // We do not care about errors here because the package exists
      int pkt;
      while( (pkt = WSNextPacket(pHandle), pkt) &amp;&amp; pkt != RETURNPKT)
        WSNewPacket(pHandle);

      logger() &lt;&lt; &quot;Succeeded in loading &quot; &lt;&lt; corrected_path(be,ver)
               &lt;&lt; LogTags::backends &lt;&lt; LogTags::info &lt;&lt; EOM;
      works[be+ver] = true;
      loaded_mathematica_backends[be+ver] = pHandle;
      WSNewPacket(pHandle);

      //TODO: Add this to die functions
      //WSPutFunction(pHandle, &quot;Exit&quot;, 0);
      //WSClose(pHandle);
      //WSDeinitialize(WSenv);
    }

  #endif


  #ifdef HAVE_PYBIND11

    void Backends::backend_info::loadLibrary_Python(const str&amp; be, const str&amp; ver, const str&amp; sv, const str&amp; lang)
    {
      // Set the internal info for this backend
      const str path = corrected_path(be,ver);
      link_versions(be, ver, sv);

      // Bail now if the backend is not present.
      std::ifstream f(path.c_str());
      std::ostringstream err;
      if(!f.good())
      {
        err &lt;&lt; &quot;Failed loading Python backend; source file not found at &quot; &lt;&lt; path &lt;&lt; endl;
        backend_warning().raise(LOCAL_INFO, err.str());
        works[be+ver] = false;
        return;
      }

      // Bail now if the backend requires a version of Python that GAMBIT is not configured with.
      if (PYTHON_VERSION_MAJOR &lt; 2 or PYTHON_VERSION_MAJOR &gt; 3)
      {
        err &lt;&lt; &quot;Unrecognised version of Python: &quot; &lt;&lt; PYTHON_VERSION_MAJOR &lt;&lt; endl;
        backend_error().raise(LOCAL_INFO, err.str());
        works[be+ver] = false;
        return;
      }
      if (PYTHON_VERSION_MAJOR != 2 and (lang == &quot;Python2&quot; or lang == &quot;PYTHON2&quot;))
      {
        err &lt;&lt; &quot;Failed loading Python backend &quot; &lt;&lt; be &lt;&lt; &quot; &quot; &lt;&lt; ver &lt;&lt; &quot;.&quot; &lt;&lt; endl
            &lt;&lt; &quot;GAMBIT was configured with Python &quot; &lt;&lt; PYTHON_VERSION_MAJOR &lt;&lt; &quot; but this backend needs Python 2.&quot; &lt;&lt; endl;
        backend_warning().raise(LOCAL_INFO, err.str());
        works[be+ver] = false;
        missingPythonVersion[be+ver] = 2;
        return;
      }
      if (PYTHON_VERSION_MAJOR != 3 and (lang == &quot;Python3&quot; or lang == &quot;PYTHON3&quot;))
      {
        err &lt;&lt; &quot;Failed loading Python backend &quot; &lt;&lt; be &lt;&lt; &quot;.&quot; &lt;&lt; endl
            &lt;&lt; &quot;GAMBIT was configured with Python &quot; &lt;&lt; PYTHON_VERSION_MAJOR &lt;&lt; &quot; but this backend needs Python 3.&quot; &lt;&lt; endl;
        backend_warning().raise(LOCAL_INFO, err.str());
        works[be+ver] = false;
        missingPythonVersion[be+ver] = 3;
        return;
      }

      // Fire up the Python interpreter if it hasn't been started yet.
      if (not python_started) start_python();

      // Add the path to the backend to the Python system path
      pybind11::object sys_path = sys-&gt;attr(&quot;path&quot;);
      pybind11::object sys_path_insert = sys_path.attr(&quot;insert&quot;);
      sys_path_insert(0,path_dir(be, ver));

      // Function to remove the location of the library after we attempted to load it.
      pybind11::object sys_path_remove = sys_path.attr(&quot;remove&quot;);

      // Attempt to import the module
      const str name = lib_name(be, ver);
      pybind11::module* new_module;
      try
      {
        new_module = new pybind11::module(pybind11::module::import(name.c_str()));
      }
      catch (std::exception&amp; e)
      {
        err &lt;&lt; &quot;Failed to import Python module from &quot; &lt;&lt; path &lt;&lt; &quot;.&quot; &lt;&lt; endl
            &lt;&lt; &quot;Python error was: &quot; &lt;&lt; e.what() &lt;&lt; endl;
        backend_warning().raise(LOCAL_INFO, err.str());
        works[be+ver] = false;
        // Remove the path to the backend from the Python system path
        sys_path_remove(path_dir(be, ver));
        return;
      }

      // Check if the loaded moule has actually come from the expected path.
      // First get the relevant os functions.
      pybind11::object os_path = os-&gt;attr(&quot;path&quot;);
      pybind11::object os_path_split = os_path.attr(&quot;split&quot;);
      // Get the path to the loaded module (Split the path at the last '/')
      pybind11::tuple full_loaded_path = os_path_split( new_module-&gt;attr(&quot;__file__&quot;) );
      // For Python modules with an underlying '__init__.py' script we need to repeat this split step
      if ((full_loaded_path[1]).cast&lt;str&gt;().find(&quot;__init__&quot;) != str::npos)
        full_loaded_path = os_path_split(full_loaded_path[0]);

      // Compare the expected and the actual location. If they differ, declare the module as broken.
      const str loaded_loc = (full_loaded_path[0]).cast&lt;str&gt;();
      const str expected_loc = path_dir(be,ver);
      if (loaded_loc.compare(expected_loc) != 0)
      {
        err &lt;&lt; &quot;Failed to import Python module from &quot; &lt;&lt; path &lt;&lt; &quot;.&quot; &lt;&lt; endl
            &lt;&lt; &quot;A module with the same name was loaded but its location is not what is expected&quot; &lt;&lt; endl
            &lt;&lt; &quot;Got: &quot; &lt;&lt; loaded_loc &lt;&lt; &quot; (expected: &quot; &lt;&lt; expected_loc &lt;&lt; &quot;)&quot; &lt;&lt; endl;
        backend_warning().raise(LOCAL_INFO, err.str());
        works[be+ver] = false;
        // Remove the path to the backend from the Python system path
        sys_path_remove(path_dir(be, ver));
        return;
      }

      // Remove the path to the backend from the Python system path
      sys_path_remove(path_dir(be, ver));

      logger() &lt;&lt; &quot;Succeeded in loading &quot; &lt;&lt; path &lt;&lt; LogTags::backends &lt;&lt; LogTags::info &lt;&lt; EOM;
      works[be+ver] = true;
      loaded_python_backends[be+ver] = new_module;
    }

    void Backends::backend_info::start_python()
    {
      // Create an instance of the interpreter.
      python_interpreter = new pybind11::scoped_interpreter;
      // Import the sys module, and save a wrapper to it for later.
      static pybind11::module local_sys = pybind11::module::import(&quot;sys&quot;);
      sys = &amp;local_sys;
      // Import the os module, and save a wrapper to it for later.
      static pybind11::module local_os = pybind11::module::import(&quot;os&quot;);
      os = &amp;local_os;

      logger() &lt;&lt; LogTags::backends &lt;&lt; LogTags::debug &lt;&lt; &quot;Python interpreter successfully started.&quot; &lt;&lt; EOM;
      python_started = true;
    }

    pybind11::module&amp; Backends::backend_info::getPythonBackend(const str&amp; be, const str&amp; ver)
    {
      static pybind11::module empty_python_module;
      return (works.at(be+ver) ? *loaded_python_backends.at(be+ver) : empty_python_module);
    }

  #endif

}
</code></pre><hr><p>Updated on 2022-07-20 at 17:18:48 +0000</p><div class=edit-page><a href=https://github.com/RC1242RC/gambit_gh_pages/blob/master/content/en/documentation/code/Files/backend__info_8cpp.md><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828.0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>Edit this page on GitHub</a></div></main></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a class=text-muted href=https://www.netlify.com/>Netlify</a>, <a class=text-muted href=https://gohugo.io/>Hugo</a>, and <a class=text-muted href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline><li class=list-inline-item><a href=/testbit/license/>License</a></li></ul></div></div></div></footer><script src=/testbit/js/bootstrap.min.54bf0932b8a36d0e152b1635b099a6ef1394d35327e2437550a075c9c8ed1bd8aed5847c21b36fc02ed24014c031d9ca24017b0c78b1639d7e2fa8329898b842.js integrity="sha512-VL8JMrijbQ4VKxY1sJmm7xOU01Mn4kN1UKB1ycjtG9iu1YR8IbNvwC7SQBTAMdnKJAF7DHixY51+L6gymJi4Qg==" crossorigin=anonymous defer></script>
<script src=/testbit/js/highlight.min.5b48bc253dc75aeea5fb366ecf700f4925e2b6eb1a1466f2124b722d68148d67bc0a9365d2b8ad9c585161b46372d23b08509a16f1fd518542b894756d4752d0.js integrity="sha512-W0i8JT3HWu6l+zZuz3APSSXitusaFGbyEktyLWgUjWe8CpNl0ritnFhRYbRjctI7CFCaFvH9UYVCuJR1bUdS0A==" crossorigin=anonymous defer></script>
<script src=/testbit/main.min.40265e9a032aeba5eaf67baac3cbbc22667a7533215d326eeb3e9f4d5e4be40f9ff4dcd22949db73ae527ca26a19d7998091a8973c82af760b2c0daa335190ed.js integrity="sha512-QCZemgMq66Xq9nuqw8u8ImZ6dTMhXTJu6z6fTV5L5A+f9NzSKUnbc65SfKJqGdeZgJGolzyCr3YLLA2qM1GQ7Q==" crossorigin=anonymous defer></script>
<script src=https://rc1242rc.github.io/testbit/index.min.a9e8ad821b751fa50133c3aa34a59cd35272c1cf2c5998ff27d4feca4a0d22445ae367b71bd8ea9be1e28558292ba08731585d275b00c18a8364fce62bfdcbd6.js integrity="sha512-qeitght1H6UBM8OqNKWc01Jywc8sWZj/J9T+ykoNIkRa42e3G9jqm+HihVgpK6CHMVhdJ1sAwYqDZPzmK/3L1g==" crossorigin=anonymous defer></script></body></html>