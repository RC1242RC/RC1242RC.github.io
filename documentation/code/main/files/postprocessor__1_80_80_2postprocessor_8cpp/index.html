<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://rc1242rc.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://rc1242rc.github.io/fonts/vendor/jost/jost-v4-latin-500.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://rc1242rc.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><script>(()=>{var e=localStorage.getItem("theme");e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><link rel=stylesheet href=https://rc1242rc.github.io/main.f12f7e04ea768acebec10c86baf049d74d6a79f24bc0dfb7ed77aa60462432916dd1ce8f41c78b69496adf650b3039a28a210183cce598f09b95d6fecb5ff999.css integrity="sha512-8S9+BOp2is6+wQyGuvBJ101qefJLwN+37XeqYEYkMpFt0c6PQceLaUlq32ULMDmiiiEBg8zlmPCbldb+y1/5mQ==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>file postprocessor_1.0.0/postprocessor_1.0.0/postprocessor.cpp - GAMBIT</title><meta name=description content="[No description available]"><link rel=canonical href=https://rc1242rc.github.io/documentation/code/main/files/postprocessor__1_80_80_2postprocessor_8cpp/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="file postprocessor_1.0.0/postprocessor_1.0.0/postprocessor.cpp"><meta property="og:description" content="[No description available]"><meta property="og:url" content="https://rc1242rc.github.io/documentation/code/main/files/postprocessor__1_80_80_2postprocessor_8cpp/"><meta property="og:site_name" content="GAMBIT"><meta property="og:image" content="https://rc1242rc.github.io/gambit_logo.png"><meta property="og:image:alt" content="GAMBIT"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content><meta name=twitter:creator content><meta name=twitter:title content="file postprocessor_1.0.0/postprocessor_1.0.0/postprocessor.cpp"><meta name=twitter:description content="[No description available]"><meta name=twitter:image content="https://rc1242rc.github.io/gambit_logo.png"><meta name=twitter:image:alt content="file postprocessor_1.0.0/postprocessor_1.0.0/postprocessor.cpp"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://rc1242rc.github.io/#/schema/organization/1","name":"Doks","url":"https://rc1242rc.github.io/","sameAs":["https://github.com/GambitBSM"],"logo":{"@type":"ImageObject","@id":"https://rc1242rc.github.io/#/schema/image/1","url":"https://rc1242rc.github.io/logo-doks.png","width":450,"height":416,"caption":"Doks"},"image":{"@id":"https://rc1242rc.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://rc1242rc.github.io/#/schema/website/1","url":"https://rc1242rc.github.io/","name":"GAMBIT","description":"Documentation for the Global And Modular BSM Inference Tool","publisher":{"@id":"https://rc1242rc.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://rc1242rc.github.io/documentation/code/main/files/postprocessor__1_80_80_2postprocessor_8cpp/","url":"https://rc1242rc.github.io/documentation/code/main/files/postprocessor__1_80_80_2postprocessor_8cpp/","name":"file postprocessor_1.0.0\/postprocessor_1.0.0\/postprocessor.cpp","description":"[No description available]","isPartOf":{"@id":"https://rc1242rc.github.io/#/schema/website/1"},"about":{"@id":"https://rc1242rc.github.io/#/schema/organization/1"},"datePublished":"0001-01-01T00:00:00CET","dateModified":"0001-01-01T00:00:00CET","breadcrumb":{"@id":"https://rc1242rc.github.io/documentation/code/main/files/postprocessor__1_80_80_2postprocessor_8cpp/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://rc1242rc.github.io/documentation/code/main/files/postprocessor__1_80_80_2postprocessor_8cpp/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://rc1242rc.github.io/documentation/code/main/files/postprocessor__1_80_80_2postprocessor_8cpp/"]}]},{"@type":"BreadcrumbList","@id":"https://rc1242rc.github.io/documentation/code/main/files/postprocessor__1_80_80_2postprocessor_8cpp/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://rc1242rc.github.io/","url":"https://rc1242rc.github.io/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://rc1242rc.github.io/documentation/","url":"https://rc1242rc.github.io/documentation/","name":"Documentation"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://rc1242rc.github.io/documentation/code/","url":"https://rc1242rc.github.io/documentation/code/","name":"Code"}},{"@type":"ListItem","position":4,"item":{"@type":"WebPage","@id":"https://rc1242rc.github.io/documentation/code/main/","url":"https://rc1242rc.github.io/documentation/code/main/","name":"Main"}},{"@type":"ListItem","position":5,"item":{"@type":"WebPage","@id":"https://rc1242rc.github.io/documentation/code/main/files/","url":"https://rc1242rc.github.io/documentation/code/main/files/","name":"Files"}},{"@type":"ListItem","position":6,"item":{"@id":"https://rc1242rc.github.io/documentation/code/main/files/postprocessor__1_80_80_2postprocessor_8cpp/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://rc1242rc.github.io/documentation/code/main/files/postprocessor__1_80_80_2postprocessor_8cpp/#/schema/image/2","url":"https://rc1242rc.github.io/gambit_logo.png","contentUrl":"https://rc1242rc.github.io/gambit_logo.png","caption":"file postprocessor_1.0.0\/postprocessor_1.0.0\/postprocessor.cpp"}]}]}</script><meta name=theme-color content="#fff"><link rel=icon href=https://rc1242rc.github.io/favicon.ico sizes=any><link rel=icon type=image/svg+xml href=https://rc1242rc.github.io/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=https://rc1242rc.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://rc1242rc.github.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://rc1242rc.github.io/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://rc1242rc.github.io/site.webmanifest></head><body class="documentation single light"><div class=sticky-top><div class=header-bar></div><header class="navbar navbar-expand-md navbar-light doks-navbar"><nav class="container-xxl flex-wrap flex-md-nowrap" aria-label="Main navigation"><a class="navbar-brand p-0 me-auto" href=https://rc1242rc.github.io/ aria-label=GAMBIT><img class=logo-light src=https://rc1242rc.github.io//images/gambit_logo.png width=50px>
<img class="logo-dark d-none" src=https://rc1242rc.github.io//images/gambit_logo.png width=50px>
GAMBIT</a>
<button class="btn btn-menu order-2 d-block d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-end border-0 py-lg-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-lg-none"></div><div class="offcanvas-header d-lg-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=/>GAMBIT</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body p-4 p-lg-0"><ul class="nav flex-column flex-lg-row align-items-lg-center mt-2 mt-lg-0 ms-lg-2 me-lg-auto"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle ps-0 py-1" href=# id=navbarDropdownMenuLink role=button data-bs-toggle=dropdown aria-expanded=false>Documentation
<span class=dropdown-caret><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></span></a><ul class="dropdown-menu dropdown-menu-main shadow rounded border-0" aria-labelledby=navbarDropdownMenuLink><li><a class=dropdown-item href=/documentation/installation/introduction/>Installation</a></li><li><a class=dropdown-item href=/documentation/examples/colliderbit>Examples</a></li><li><a class=dropdown-item href=/documentation/help/faqs/>Help</a></li><li><a class=dropdown-item href=/documentation/code/index_classes>Code Reference</a></li></ul></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle ps-0 py-1" href=# id=navbarDropdownMenuLink role=button data-bs-toggle=dropdown aria-expanded=false>Community
<span class=dropdown-caret><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></span></a><ul class="dropdown-menu dropdown-menu-main shadow rounded border-0" aria-labelledby=navbarDropdownMenuLink><li><a class=dropdown-item href=/community/publications/>Publications</a></li><li><a class=dropdown-item href=/community/talks/>Talks</a></li><li><a class=dropdown-item href=/community/members/>Members</a></li><li><a class=dropdown-item href=/community/code_of_conduct/>Code of Conduct</a></li><li><a class=dropdown-item href=/community/contact/>Contact</a></li></ul></li></ul><hr class="text-black-50 my-4 d-lg-none"><form class="doks-search position-relative flex-grow-1 ms-lg-auto me-lg-2"><input id=search class="form-control is-search" type=search placeholder="Search site..." aria-label="Search site..." autocomplete=off><div id=suggestions class="shadow bg-white rounded d-none"></div></form><hr class="text-black-50 my-4 d-lg-none"><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=https://github.com/GambitBSM><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-lg-none">GitHub</small></a></li></ul><hr class="text-black-50 my-4 d-lg-none"><div class=dropdown><button class="btn btn-doks-light dropdown-toggle" id=doks-versions data-bs-toggle=dropdown aria-expanded=false data-bs-display=static aria-label="Toggle version menu">
<span class=d-none>Doks</span>
<span class=dropdown-caret><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></span></button><ul class="dropdown-menu dropdown-menu-lg-end me-lg-2 shadow rounded border-0" aria-labelledby=doks-versions></ul></div></div></div></nav></header></div><div class="wrap container-xxl" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 docs-sidebar"><nav class=docs-links aria-label="Main navigation"><ul class="list-unstyled collapsible-sidebar"><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-installation aria-expanded=false>
Installation</button><div class=collapse id=section-installation><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=/documentation/installation/introduction/>Getting Started</a></li><li><a class="docs-link rounded" href=/documentation/installation/docker_usage/>Docker Usage</a></li><li><a class="docs-link rounded" href=/documentation/installation/installation_for_linux/>Installation for Linux</a></li><li><a class="docs-link rounded" href=/documentation/installation/installation_for_windows/>Installation for Windows</a></li><li><a class="docs-link rounded" href=/documentation/installation/installation_for_macos/>Installation for macOS</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-examples aria-expanded=false>
Examples</button><div class=collapse id=section-examples><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=/documentation/examples/colliderbit/>ColliderBit</a></li><li><a class="docs-link rounded" href=/documentation/examples/anotherbit/>AnotherBit</a></li><li><a class="docs-link rounded" href=/documentation/examples/anotherbit2/>AnotherBit2</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-help aria-expanded=false>
Help</button><div class=collapse id=section-help><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=/documentation/help/faqs/>FAQs</a></li><li><a class="docs-link rounded" href=/documentation/help/compiler_matrix/>Compiler Matrix</a></li><li><a class="docs-link rounded" href=/documentation/help/known_issues/>Known Issues</a></li><li><a class="docs-link rounded" href=/documentation/help/configuration_examples/>Configuration Examples</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-code aria-expanded=false>
Code Reference</button></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section- aria-expanded=false>
GAMBIT_VERSION_HERE</button><div class=collapse id=section-><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=/documentation/code/colliderbit_development/index_classes/>Classes</a></li><li><a class="docs-link rounded" href=/documentation/code/colliderbit_development/index_files/>Files</a></li><li><a class="docs-link rounded" href=/documentation/code/colliderbit_development/index_pages/>Pages</a></li><li><a class="docs-link rounded" href=/documentation/code/colliderbit_development/index_namespaces/>Namespaces</a></li></ul></div></li></ul></nav></div><nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=d-xl-none><button class="btn btn-outline-primary btn-sm doks-toc-toggle collapsed" type=button data-bs-toggle=collapse data-bs-target=#onThisPage aria-controls=doks-docs-nav aria-expanded=false aria-label="Toggle On this page navigation">
<span>On this page</span>
<span><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-expand" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Expand</title><polyline points="7 13 12 18 17 13"/><polyline points="7 6 12 11 17 6"/></svg><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-collapse" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Collapse</title><polyline points="17 11 12 6 7 11"/><polyline points="17 18 12 13 7 18"/></svg></span></button><div class=collapse id=onThisPage><div class="card card-body mt-3 py-1"><div class=page-links><nav id=TableOfContents><ul><li><ul><li><a href=#functions>Functions</a></li><li><a href=#detailed-description>Detailed Description</a></li><li><a href=#functions-documentation>Functions Documentation</a><ul><li><a href=#function-scanner_plugin>function scanner_plugin</a></li></ul></li><li><a href=#source-code>Source code</a></li></ul></li></ul></nav></div></div></div></div><div class="page-links d-none d-xl-block"><h3>On this page</h3><nav id=TableOfContents><ul><li><ul><li><a href=#functions>Functions</a></li><li><a href=#detailed-description>Detailed Description</a></li><li><a href=#functions-documentation>Functions Documentation</a><ul><li><a href=#function-scanner_plugin>function scanner_plugin</a></li></ul></li><li><a href=#source-code>Source code</a></li></ul></li></ul></nav></div></nav><main class="docs-content col-lg-11 col-xl-9 mx-xl-auto"><h1>file postprocessor_1.0.0/postprocessor_1.0.0/postprocessor.cpp</h1><p class=lead></p><p>[No description available] <a href=#detailed-description>More&mldr;</a></p><h2 id=functions>Functions <a href=#functions class=anchor aria-hidden=true>#</a></h2><table><thead><tr><th></th><th>Name</th></tr></thead><tbody><tr><td></td><td><strong><a href=/documentation/code/main/files/postprocessor__1_80_80_2postprocessor_8cpp/#function-scanner-plugin>scanner_plugin</a></strong>(postprocessor , version(1, 0, 0) )</td></tr></tbody></table><h2 id=detailed-description>Detailed Description <a href=#detailed-description class=anchor aria-hidden=true>#</a></h2><p>&ldquo;Postprocessing&rdquo; scanner plugin. Reads points from old scan output and re-runs a likelihood containing plugin for those same point. Can perform some simple addition/subtraction operations of likelihood components from the new plugin output.</p><hr><p>Authors (add name and date if you modify):</p><h2 id=functions-documentation>Functions Documentation <a href=#functions-documentation class=anchor aria-hidden=true>#</a></h2><h3 id=function-scanner_plugin>function scanner_plugin <a href=#function-scanner_plugin class=anchor aria-hidden=true>#</a></h3><pre><code>scanner_plugin(
    postprocessor ,
    version(1, 0, 0) 
)
</code></pre><p>The likelihood container plugin</p><p>MPI data</p><p>The reader object in use for the scan</p><p>The main postprocessing driver object</p><p>Options for PPDriver;</p><p>The constructor to run when the plugin is loaded.</p><p>Main run function</p><p>Determine what data needs to be copied from the input file to the new output dataset</p><h2 id=source-code>Source code <a href=#source-code class=anchor aria-hidden=true>#</a></h2><pre><code>//  GAMBIT: Global and Modular BSM Inference Tool
//  *********************************************
//

// STL
#include &lt;vector&gt;
#include &lt;string&gt;
#include &lt;cmath&gt;
#include &lt;cstdio&gt;
#include &lt;iostream&gt;
#include &lt;fstream&gt;
#include &lt;sstream&gt;

// GAMBIT
#include &quot;gambit/Utils/mpiwrapper.hpp&quot;
#include &quot;gambit/Utils/util_functions.hpp&quot;
#include &quot;gambit/Utils/new_mpi_datatypes.hpp&quot;
#include &quot;gambit/ScannerBit/scanners/postprocessor_1.0.0/postprocessor.hpp&quot;
#include &quot;gambit/ScannerBit/objective_plugin.hpp&quot;
#include &quot;gambit/ScannerBit/scanner_plugin.hpp&quot;

using namespace Gambit;
using namespace Gambit::PostProcessor;


// The reweigher Scanner plugin
scanner_plugin(postprocessor, version(1, 0, 0))
{
  reqd_inifile_entries(&quot;like&quot;,&quot;reader&quot;);

  like_ptr LogLike;

  unsigned int numtasks;
  unsigned int rank;

  Gambit::Printers::BaseBaseReader* reader;

  PPDriver driver;

  PPOptions settings;

  // Retrieve an integer from an environment variable
  int getintenv(const std::string&amp; name)
  {
     int x = 0;
     if(const char* env_p = std::getenv(name.c_str()))
     {
       std::stringstream env_s(env_p);
       env_s &gt;&gt; x;
       if (!env_s)
       {
          std::ostringstream err;
          err &lt;&lt; &quot;Tried to retrieve value of environment variable &quot;&lt;&lt;name&lt;&lt;&quot; as an integer, but conversion failed! String retrieved was '&quot;&lt;&lt;env_s.str()&lt;&lt;&quot;'&quot;;
          scan_error().raise(LOCAL_INFO,err.str());
       }
     }
     else
     {
       std::ostringstream err;
       err &lt;&lt; &quot;Tried to retrieve value of environment variable &quot;&lt;&lt;name&lt;&lt;&quot; as an integer, but it does not seem to be defined!&quot;;
       scan_error().raise(LOCAL_INFO,err.str());
     }
     return x;
  }

  plugin_constructor
  {
    int s_numtasks;
    int s_rank;

    // Get MPI data. No communication is needed, we just need to know how to
    // split up the workload. Just a straight division among all processes is
    // used, nothing fancy.
#ifdef WITH_MPI
    MPI_Comm_size(MPI_COMM_WORLD, &amp;s_numtasks); // MPI requires unsigned ints here, so we'll just convert afterwards
    MPI_Comm_rank(MPI_COMM_WORLD, &amp;s_rank);
#else
    s_numtasks = 1;
    s_rank = 0;
#endif
    numtasks = s_numtasks;
    rank = s_rank;

    if(rank==0) std::cout &lt;&lt; &quot;Initialising 'postprocessor' plugin for ScannerBit...&quot; &lt;&lt; std::endl;

    // Get options for setting up the reader (these live in the inifile under:
    // Scanners:
    //  scanners:
    //    scannername:
    //      reader
    Gambit::Options reader_options = get_inifile_node(&quot;reader&quot;);

    // Initialise reader object
    get_printer().new_reader(&quot;old_points&quot;,reader_options);

    // Retrieve the reader object
    reader = get_printer().get_reader(&quot;old_points&quot;);

    // Get names of all the output data labels
    settings.data_labels = reader-&gt;get_all_labels();

    // Set up other options for the plugin
    settings.update_interval = get_inifile_value&lt;std::size_t&gt;(&quot;update_interval&quot;, 1000);
    settings.add_to_logl = get_inifile_value&lt;std::vector&lt;std::string&gt;&gt;(&quot;add_to_like&quot;, std::vector&lt;std::string&gt;());
    settings.subtract_from_logl = get_inifile_value&lt;std::vector&lt;std::string&gt;&gt;(&quot;subtract_from_like&quot;, std::vector&lt;std::string&gt;());
    settings.reweighted_loglike_name = get_inifile_value&lt;std::string&gt;(&quot;reweighted_like&quot;);

    settings.renaming_scheme = get_inifile_value&lt;std::map&lt;std::string,std::string&gt;&gt;(&quot;rename&quot;,
                          std::map&lt;std::string,std::string&gt;());

    settings.cut_less_than = get_inifile_value&lt;std::map&lt;std::string,double&gt;&gt;(&quot;cut_less_than&quot;,
                          std::map&lt;std::string,double&gt;());

    settings.cut_greater_than = get_inifile_value&lt;std::map&lt;std::string,double&gt;&gt;(&quot;cut_greater_than&quot;,
                          std::map&lt;std::string,double&gt;());

    settings.discard_points_outside_cuts = get_inifile_value&lt;bool&gt;(&quot;discard_points_outside_cuts&quot;, false);

    // Use virtual rank system?
    if(get_inifile_value&lt;bool&gt;(&quot;use_virtual_rank&quot;,false))
    {
        #ifdef WITH_MPI
        if(numtasks&gt;1)
        {
          std::ostringstream err;
          err &lt;&lt; &quot;You have set the 'use_virtual_rank' option for the postprocessor scanner plugin to 'true', which will allow the plugin to act as if it is part of an MPI ensemble when it really isn't, however you are also running this task in an MPI batch with size &gt; 1! You cannot use the virtual rank system at the same time as running a real MPI job! Please choose one configuration or the other and rerun the job.&quot;;
          scan_error().raise(LOCAL_INFO,err.str());
        }
        #endif
        rank     = getintenv(&quot;RANK&quot;);
        numtasks = getintenv(&quot;SIZE&quot;);
        if(rank&gt;=numtasks)
        {
          std::ostringstream err;
          err &lt;&lt; &quot;Environment variable RANK was larger than permitted by SIZE (&quot;&lt;&lt;numtasks&lt;&lt;&quot;&gt;=&quot;&lt;&lt;rank&lt;&lt;&quot;) while running postprocessor scanner plugin with 'use_virtual_rank=true' option. This is not a valid MPI configuration, so it is an illegal choice of virtual configuration.&quot;;
          scan_error().raise(LOCAL_INFO,err.str());
        }
    }
    // Transfer MPI variables to PPOptions
    settings.rank = rank;
    settings.numtasks = numtasks;

    // Finally, there is the 'Purpose' value of the likelihood container. This may well clash
    // with the old name used in the input file, so better check for this and make the user
    // change their choice if so.
    settings.logl_purpose_name = get_inifile_value&lt;std::string&gt;(&quot;like&quot;);
    settings.discard_old_logl = get_inifile_value&lt;bool&gt;(&quot;permit_discard_old_likes&quot;,false);

    // Retrieve the external likelihood calculator
    LogLike = get_purpose(settings.logl_purpose_name);

    // Do not allow GAMBIT's own likelihood calculator to directly shut down the scan.
    // This scanner plugin will assume responsibility for this process, triggered externally by
    // the 'plugin_info.early_shutdown_in_progress()' function.
    LogLike-&gt;disable_external_shutdown();

    // Path to save resume files
    std::string defpath = get_inifile_value&lt;std::string&gt;(&quot;default_output_path&quot;);
    settings.root = Utils::ensure_path_exists(defpath+&quot;/postprocessor/resume&quot;);
    if(rank==0) std::cout &lt;&lt; &quot;root: &quot; &lt;&lt; settings.root &lt;&lt; std::endl;
  }

  int plugin_main()
  {
    if(rank==0) std::cout &lt;&lt; &quot;Running 'postprocessor' plugin for ScannerBit.&quot; &lt;&lt; std::endl;

    // Set up our MPI communicator
    #ifdef WITH_MPI
    GMPI::Comm ppComm;
    ppComm.dup(MPI_COMM_WORLD,&quot;PostprocessorComm&quot;); // duplicates MPI_COMM_WORLD
    // Message tag definitons in PPDriver class:
    #endif

    // Get labels of functors listed for printing from the primary printer.
    settings.all_params = get_printer().get_stream()-&gt;getPrintList();
    // There are some extra items that will also be automatically printed in all scans,
    // so we need to avoid copying those:
    settings.all_params.insert(&quot;unitCubeParameters&quot;); // It would be better to keep the originals here, but currently cannot turn off the printing from within like_ptr.
    settings.all_params.insert(&quot;MPIrank&quot;); // These should be re-printed the same as they were anyway
    settings.all_params.insert(&quot;pointID&quot;);
    settings.all_params.insert(settings.logl_purpose_name); // If there is a name clash and the run was not aborted, we are to discard the old data under this name.
    settings.all_params.insert(&quot;Modified&quot; + settings.logl_purpose_name);
    settings.all_params.insert(settings.reweighted_loglike_name); //   &quot;  &quot;
    #ifdef WITH_MPI
    settings.comm = &amp;ppComm;
    #endif

    // Construct the main driver object
    driver = PPDriver(reader,get_printer().get_stream(),LogLike,settings);

    // Check that the supplied settings make sense
    driver.check_settings();

    // Points which have already been processed in a previous (aborted) run
    ChunkSet done_chunks; // Empty by default

    // Ask the printer if this is a resumed run or not, and check that the necessary files exist if so.
    bool resume = get_printer().resume_mode();

    //MAIN LOOP HERE
    bool continue_processing = true;
    #ifdef WITH_MPI
      bool quit_flag_seen = false;
    #endif
    while(continue_processing)
    {
       #ifdef WITH_MPI
         bool I_am_finished = false;
       #endif
       if (resume) // If resuming (or redistributing), get the required resume data
       {
          done_chunks = get_done_points(settings.root);
          // For debugging: report on the retrieved chunks
          //for(auto it=done_chunks.begin(); it!=done_chunks.end(); ++it)
          //   std::cout &lt;&lt; &quot;Rank &quot;&lt;&lt;rank&lt;&lt;&quot;: retrieved done_chunk [&quot;&lt;&lt;it-&gt;start&lt;&lt;&quot;,&quot;&lt;&lt;it-&gt;end&lt;&lt;&quot;]&quot;&lt;&lt;std::endl;
       }

       bool do_redistribution = false;
       int exit_code;
       // 0 - Finished processing all the points we were assigned
       // 1 - Saw quit flag and so stopped prematurely
       // 2 - Was told to stop by some other process for redistribution of postprocessing work
       // 3 - Encountered end of input file unexpectedly
       exit_code = driver.run_main_loop(done_chunks);
       std::cout &lt;&lt; &quot;Rank &quot;&lt;&lt;rank&lt;&lt;&quot;: exited loop with code &quot;&lt;&lt;exit_code&lt;&lt;std::endl;
       if(exit_code==0)
       {
          #ifdef WITH_MPI
            I_am_finished = true;
          #endif
          std::cout &lt;&lt; &quot;Rank &quot;&lt;&lt;rank&lt;&lt;&quot; has finished processing its batch; requesting work from other processes.&quot; &lt;&lt; std::endl;
          // We are finished, but there might still be lots of points to process
          // that are assigned to other cpus in this job. We will request that
          // all processes stop and redistribute their workload.
          // But first, we check if anyone else has already requested this stop!
          // In that case there is no need to send another stop message.
          #ifdef WITH_MPI
            if(not driver.check_for_redistribution_request())
            {
               driver.send_redistribution_request();
            }
            do_redistribution = true;
          #endif
       }
       else if(exit_code==1)
       {
          // Saw quit flag, time to stop
          #ifdef WITH_MPI
            quit_flag_seen = true;
          #endif
          continue_processing = false;
          do_redistribution = true; // Need to unlock processes that may be waiting for point redistribution
       }
       else if(exit_code==2)
       {
          // Stopped due to workload redistribution request from another process.
          do_redistribution = true;
       }
       else if(exit_code==3)
       {
          // That shouldn't happen; warning
          std::ostringstream err;
          err &lt;&lt; &quot;Postprocessing on &quot;&lt;&lt;rank&lt;&lt;&quot; ended due to encountering the end of the input file. This indicates that it was told to process more points than existed in the input file, which indicates a bug in the postprocessor. Your output may still be fine, but please report this bug.&quot;;
          std::cerr &lt;&lt; err.str() &lt;&lt; std::endl;
          scan_error().raise(LOCAL_INFO,err.str());
       }
       else
       {
          std::ostringstream err;
          err &lt;&lt; &quot;Postprocessing on &quot;&lt;&lt;rank&lt;&lt;&quot; terminated with an unrecognised return code (&quot;&lt;&lt;exit_code&lt;&lt;&quot;). This indicates a bug in the postprocessor, please report it.&quot;;
          scan_error().raise(LOCAL_INFO,err.str());
       }

       // Redistribute points, stop if someone has seen the quit flag, or stop if there are no points left to process
       if(do_redistribution)
       {
          #ifdef WITH_MPI
            int my_finished = (I_am_finished ? 1 : 0); // convert to int in a way that prevents unused-variable warnings
            std::vector&lt;int&gt; all_finished = allgather_int(my_finished, ppComm);
            bool everyone_finished = true;
            int tmp_rank = 0;
            for(auto it=all_finished.begin(); it!=all_finished.end(); ++it)
            {
               if(*it!=1)
               {
                  //std::cout &lt;&lt; &quot;Rank &quot;&lt;&lt;rank&lt;&lt;&quot;: rank &quot;&lt;&lt;tmp_rank&lt;&lt;&quot; is not finished (&quot;&lt;&lt;*it&lt;&lt;&quot;)&quot;&lt;&lt;std::endl;
                  everyone_finished = false; // If anyone has not finished, we proceed with redistribution.
               }
               tmp_rank++;
            }

            // All processes should now be synchronised; receive all the redistribution requests
            std::cout &lt;&lt; &quot;Rank &quot;&lt;&lt;rank&lt;&lt;&quot;: Clearing redistribution request messages&quot; &lt;&lt; std::endl;
            driver.clear_redistribution_requests();

            if(not everyone_finished)
            {
               int my_quit = (quit_flag_seen ? 1 : 0); // convert to int in a way that prevents unused-variable warnings
               std::vector&lt;int&gt; all_quit_flags = allgather_int(my_quit, ppComm);
               for(auto it=all_quit_flags.begin(); it!=all_quit_flags.end(); ++it)
               {
                  if(*it==1)
                  {
                     continue_processing = false; // If anyone has seen the quit flag, we must stop.
                  }
               }
               if(continue_processing)
               {
                  //if(rank==0) std::cout &lt;&lt; &quot;Some processes have finished their work, but others are still going. Redistributing remaining workload amongst all available cpus&quot; &lt;&lt; std::endl;
                  std::cout &lt;&lt; &quot;Rank &quot;&lt;&lt;rank&lt;&lt;&quot;: Some processes have finished their work, but others are still going. Redistributing remaining workload amongst all available cpus&quot; &lt;&lt; std::endl;
                  resume = true; // Perform next loop as if we are resuming the scan.
               }
               else
               {
                  if(rank==0) std::cout &lt;&lt; &quot;Quit flag seen by one or more worker processes; stopping postprocessor.&quot; &lt;&lt; std::endl;
               }
            }
            else
            {
               // Everyone is finished! We can stop
               continue_processing = false;
               if(rank==0) std::cout &lt;&lt; &quot;All processes report that they are finished with their postprocessing batches. No work left to do, so we will stop.&quot; &lt;&lt; std::endl;
            }
          #endif
       }
    }
    //if(rank==0) std::cout &lt;&lt; &quot;Done!&quot; &lt;&lt; std::endl;
    std::cout &lt;&lt; &quot;Rank &quot;&lt;&lt; rank&lt;&lt; &quot;: Done!&quot; &lt;&lt; std::endl;

    // Test barrier to see if everyone made it
    #ifdef WITH_MPI
    ppComm.Barrier();
    if(rank==0) std::cout &lt;&lt; &quot;Passed final PP barrier&quot; &lt;&lt; std::endl;
    #endif
    return 0;
  }
}
</code></pre><hr><p>Updated on 2022-08-02 at 18:18:37 +0000</p><div class=edit-page><a href=https://github.com/RC1242RC/gambit_gh_pages/blob/master/content/en/documentation/code/main/Files/postprocessor__1_80_80_2postprocessor_8cpp.md><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828.0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>Edit this page on GitHub</a></div></main></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a class=text-muted href=https://www.netlify.com/>Netlify</a>, <a class=text-muted href=https://gohugo.io/>Hugo</a>, and <a class=text-muted href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline><li class=list-inline-item><a href=/license/>License</a></li></ul></div></div></div></footer><script src=/js/bootstrap.min.54bf0932b8a36d0e152b1635b099a6ef1394d35327e2437550a075c9c8ed1bd8aed5847c21b36fc02ed24014c031d9ca24017b0c78b1639d7e2fa8329898b842.js integrity="sha512-VL8JMrijbQ4VKxY1sJmm7xOU01Mn4kN1UKB1ycjtG9iu1YR8IbNvwC7SQBTAMdnKJAF7DHixY51+L6gymJi4Qg==" crossorigin=anonymous defer></script>
<script src=/js/highlight.min.5b48bc253dc75aeea5fb366ecf700f4925e2b6eb1a1466f2124b722d68148d67bc0a9365d2b8ad9c585161b46372d23b08509a16f1fd518542b894756d4752d0.js integrity="sha512-W0i8JT3HWu6l+zZuz3APSSXitusaFGbyEktyLWgUjWe8CpNl0ritnFhRYbRjctI7CFCaFvH9UYVCuJR1bUdS0A==" crossorigin=anonymous defer></script>
<script src=/main.min.40265e9a032aeba5eaf67baac3cbbc22667a7533215d326eeb3e9f4d5e4be40f9ff4dcd22949db73ae527ca26a19d7998091a8973c82af760b2c0daa335190ed.js integrity="sha512-QCZemgMq66Xq9nuqw8u8ImZ6dTMhXTJu6z6fTV5L5A+f9NzSKUnbc65SfKJqGdeZgJGolzyCr3YLLA2qM1GQ7Q==" crossorigin=anonymous defer></script>
<script src=https://rc1242rc.github.io/index.min.97d6402d7a34cdd5bd42756d4cab0cf30d540a9cfd60b87b21ea49bb4e8ab243c43c3171889d41e133bd95a5c6d18e02d0f4cd3d09c2e02e58f2cc367481d403.js integrity="sha512-l9ZALXo0zdW9QnVtTKsM8w1UCpz9YLh7IepJu06KskPEPDFxiJ1B4TO9laXG0Y4C0PTNPQnC4C5Y8sw2dIHUAw==" crossorigin=anonymous defer></script></body></html>